# 远程开机助手项目 - 产品需求文档 (PRD)

**版本:** V1.0  
**日期:** 2023-10-27  
**作者:** linyings  

## 1. 项目概述

### 1.1. 项目背景

随着智能家居和远程办公的普及，用户对远程控制个人电脑（PC）的需求日益增长。本项目旨在开发一款低成本、高可靠性的嵌入式设备，通过 Wi-Fi 网络实现对PC的远程开机和状态监控。设备将采用 Web 服务的方式提供控制界面，简化用户操作，无需安装任何专用APP。

### 1.2. 项目目标

- **远程开机:** 用户可以通过网页远程触发舵机，物理性地按下PC的电源按钮，实现开机。
- **状态监控:** 用户可以实时在网页上查看PC的运行状态（开机/关机）。
- **便捷配网:** 设备首次上电或Wi-Fi配置失效时，自动进入AP模式，提供网页配网界面，方便用户配置网络。
- **高集成度:** 将所有Web资源文件（HTML, CSS, JS）固化到设备Flash中，实现独立的Web服务能力。
- **稳定可靠:** 系统具备掉线重连机制，确保长期稳定运行。

## 2. 功能需求 (Functional Requirements)

### 2.1. 系统工作模式

系统包含两种主要工作模式：AP模式和STA模式。

| 模式 | 触发条件 | 主要功能 |
|------|----------|----------|
| AP模式 (配置模式) | 1. 首次上电<br>2. Flash中无有效Wi-Fi凭证<br>3. STA模式下连接路由器失败超过设定次数 | - 启动一个开放的Wi-Fi热点（AP）<br>- 提供Web配网页面，引导用户输入目标Wi-Fi的SSID和密码<br>- 保存用户提交的Wi-Fi凭证到NVS分区<br>- 尝试连接目标Wi-Fi并切换到STA模式 |
| STA模式 (服务模式) | 1. 成功连接到用户配置的Wi-Fi网络 | - 连接到局域网路由器，并获取IP地址<br>- 启动Web服务器，提供PC控制与监控的服务页面<br>- 执行后台任务，如PC状态检测、WebSocket通信等 |

### 2.2. Web 界面与交互

#### 2.2.1. 配网页面 (/setup)

**访问方式:** 在AP模式下，设备启动强制门户(Captive Portal)，用户连接设备AP后，访问任何网址将自动跳转到此页面。

**页面元素:**
- SSID输入框: 文本输入框，用于填写Wi-Fi网络名称。
- 密码输入框: 密码类型输入框，用于填写Wi-Fi密码。
- 连接按钮: 提交表单，将SSID和密码发送到设备。
- 可用wifi列表：显示当前可以连接的wifi。

**交互流程:**
1. 用户填写信息并点击"连接"。
2. 网页显示"正在连接，请稍候..."的提示。
3. 设备收到凭证后，保存并尝试连接。
4. 连接成功后，设备切换到STA模式，网页可提示"连接成功，请将手机连接到家庭Wi-Fi，并通过IP地址 [device_ip] 访问服务页面"。
5. 连接失败，网页提示"连接失败，请检查密码后重试"，并保持在AP模式。

#### 2.2.2. 服务页面 (/)

**访问方式:** 在STA模式下，通过设备在局域网中的IP地址访问。

**页面元素:**
- PC状态指示器: 一个醒目的图标或文本，实时显示"电脑已开机"或"电脑已关机"。
- 开机按钮: 一个标有"启动电脑"的按钮。

**交互流程:**
- 状态更新: 页面加载后，通过WebSocket或定期的HTTP请求从设备获取PC的当前状态，并实时更新。
- 开机操作:
  1. 用户点击"启动电脑"按钮。
  2. 网页通过WebSocket或HTTP POST请求向设备发送开机指令。
  3. 设备接收到指令后，驱动舵机模拟按下电源键。
  4. 按钮在点击后可短暂禁用，并显示"指令已发送"，以防重复点击。

### 2.3. 核心功能实现

#### 2.3.1. 电脑状态监控

**实现原理:** 通过检测PC开机后USB端口的5V供电来判断。当PC开机，主板USB端口会输出稳定的5V电压；关机后（非S5休眠），USB端口断电。

**硬件连接:** 将设备的某个GPIO引脚连接到PC USB口的数据线（D+或D-）或5V VBUS线（需经过分压电路降压至MCU安全电压范围）。

**软件逻辑:**
1. 定时（如每秒）读取该GPIO引脚的电平。
2. 高电平表示PC已开机，低电平表示PC已关机。
3. 状态变化时，通过WebSocket主动推送给所有连接的Web客户端。

#### 2.3.2. 远程开机控制

**实现原理:** 使用一个小型舵机（如SG90）模拟人手按压动作。

**硬件连接:**
- 舵机通过物理结构固定在PC机箱电源按钮旁。
- 舵机的PWM信号线连接到设备的一个支持PWM输出的GPIO引脚。

**软件逻辑:**
1. 接收到Web端的开机指令后。
2. 控制PWM输出，使舵机从初始角度转动到"按下"角度，短暂保持（如200ms），再返回初始角度。
3. 预设舵机的初始角度和"按下"角度，并提供校准机制（可通过串口或Web高级设置）。

## 3. 非功能性需求 (Non-Functional Requirements)

### 3.1. 性能
- Web页面响应时间应在1秒以内。
- 从点击"启动电脑"按钮到舵机动作完成，延迟应小于500毫秒。

### 3.2. 可靠性
- Wi-Fi断线后，设备应能自动尝试重连。若连续重连失败（如超过5次），应重启并进入AP模式。
- 舵机动作应精准，避免误触或操作失败。

### 3.3. 安全性
- AP模式下的Web配网页面不强制要求密码，但建议设备AP本身设置一个简单的默认密码（如mypassword），印在设备外壳上。
- STA模式下的服务页面仅在局域网内可访问，不暴露于公网。

### 3.4. 功耗
- 设备在空闲状态下应进入低功耗模式，仅维持Wi-Fi连接和基本检测。

## 4. 技术栈与硬件选型

### 4.1. 主控芯片
ESP32。理由：内置Wi-Fi和蓝牙，性能足够驱动Web服务器和业务逻辑，拥有丰富的GPIO和PWM资源，社区支持完善。

### 4.2. 开发框架
ESP-IDF。理由：提供对底层硬件和FreeRTOS的完全控制，能精确管理Flash分区（partitions.csv）和嵌入文件系统。

### 4.3. 软件技术
- Web服务器: 使用ESP-IDF内置的esp_http_server。
- 实时通信: 使用esp_http_server的WebSocket功能，实现服务器到客户端的状态推送。

### 4.4. 外围硬件
- 舵机: SG90微型舵机或同类产品。
- 电源: 5V/1A Micro-USB电源适配器。
- PC状态检测: 使用一个简单的分压电阻电路或一个专用的电平转换IC。

## 5. Flash 分区方案 (partitions.csv)

为了将Web资源文件固化到Flash并为系统保留必要空间，我们设计如下分区表。

### 5.1. partitions.csv 文件示例:

```
# ESP-IDF Partition Table
# Name,   Type, SubType, Offset,  Size, Flags
nvs,      data, nvs,     0x9000,  0x5000,
otadata,  data, ota,     0xe000,  0x2000,
app0,     app,  ota_0,   0x10000, 1M,
web_data, data, spiffs,  0x110000, 0xF0000,
```

