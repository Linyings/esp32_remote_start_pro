# Esp32远程开机宝

这是一个基于ESP32的设备，用于远程控制PC的开机，并监控PC的运行状态。项目使用ESP-IDF框架开发，提供美观的Web界面，让您可以随时随地通过手机或电脑远程开启您的PC。

## 功能特点

- **远程开机**: 通过网页远程触发舵机，物理按下PC的电源按钮，实现远程开机
- **状态监控**: 实时监测并显示PC的运行状态（开机/关机），通过WebSocket确保状态实时更新
- **智能配网**: 首次使用时自动进入配网模式，支持强制门户(Captive Portal)，连接ESP32热点后自动弹出配网页面
- **美观界面**: 响应式设计的现代UI界面，完美适配移动设备和桌面浏览器
- **网络信息**: 显示详细的网络连接信息，包括IP地址、连接状态等
- **稳定可靠**: 具备自动重连机制和状态恢复功能，确保长期稳定运行
- **双模工作**: 同时支持AP和STA模式，即使连接到家庭WiFi后，仍可通过AP模式访问设备

## 硬件配置

- **ESP32主控板**: 建议使用ESP32-WROOM或ESP32-WROVER系列
- **SG90舵机**: 用于物理按下PC电源键
- **USB检测电路**: 通过检测USB供电判断PC电源状态
- **5V电源**: 为ESP32和舵机供电

### 引脚配置

- **GPIO12**: 连接舵机信号线，用于控制舵机旋转角度
- **GPIO14**: 连接PC状态检测线，用于监测PC电源状态
- **5V**: 连接舵机电源正极
- **GND**: 连接舵机电源负极和PC状态检测电路的地线

### 硬件连接图

```
ESP32           舵机(SG90)
+-------+       +-------+
|       |       |       |
| GPIO12|-------|信号线 |
|       |       |       |
| 5V    |-------|VCC    |
|       |       |       |
| GND   |-------|GND    |
+-------+       +-------+

ESP32           PC状态检测
+-------+       +-------+
|       |       |       |
| GPIO14|-------|USB检测|
|       |       |       |
| GND   |-------|GND    |
+-------+       +-------+
```

## 软件组件

项目由以下几个主要组件构成：

### wifi_manager

WiFi管理器，负责处理设备的网络连接：

- 支持AP模式和STA模式的切换和共存
- 实现Captive Portal功能，便于首次配网
- 自动保存WiFi凭证到NVS存储
- 具备自动重连机制
- 内置DNS服务器，实现强制门户功能

### pc_monitor

PC状态监控组件，负责检测PC电源状态：

- 通过GPIO检测PC的电源状态
- 支持设置状态变化回调函数
- 实现状态防抖动处理，避免误判
- 定期轮询PC状态，确保状态实时性

### servo_control

舵机控制组件，负责控制舵机按下PC电源按钮：

- 使用LEDC驱动舵机，支持精确角度控制
- 实现按下电源键的模拟动作
- 配置为短按功能，模拟人手操作
- 支持舵机角度校准

### web_server

Web服务器组件，提供用户界面和API：

- 提供美观的响应式Web界面
- 支持WebSocket实时更新PC状态
- 提供完整API接口：电源控制、状态查询、WiFi管理等
- 内置网络信息API，显示设备网络状态
- 支持SPIFFS文件系统存储Web资源

## 构建与烧录

### 准备环境

1. 安装ESP-IDF开发环境（推荐使用v5.4或更高版本）
2. 克隆本项目到本地

### 构建项目

```bash
# 进入项目目录
cd ESP32_BUTLER_WEB_WIFI

# 设置ESP-IDF环境变量
. $IDF_PATH/export.sh  # Linux/macOS
# 或
%IDF_PATH%\export.bat  # Windows

# 构建项目
idf.py build
```

### 烧录固件

```bash
# 烧录固件到ESP32（请替换PORT为您的串口）
idf.py -p PORT flash
```

### 烧录网页资源

网页资源需要烧录到SPIFFS分区：

```bash
# 烧录网页资源到SPIFFS分区
idf.py -p PORT spiffs-flash
```

## 使用说明

### 首次使用

1. 烧录完成后，ESP32将自动创建名为"ESP32开机助手"的WiFi热点，密码为"12345678"
2. 使用手机或电脑连接到该热点
3. 连接后会自动弹出配网页面（如未弹出，请手动访问 http://192.168.4.1）
4. 在配网页面选择您的家庭WiFi网络并输入密码
5. 连接成功后，记下页面显示的IP地址（例如：192.168.1.100）
6. 将您的手机或电脑重新连接到家庭WiFi
7. 通过上述IP地址访问远程开机助手的控制界面

### 日常使用

1. 在浏览器中访问ESP32的IP地址
2. 在主控制页面，可以看到PC当前的状态（开机/关机）
3. 当PC处于关机状态时，点击"启动电脑"按钮可远程开机
4. 点击"详细信息"可查看网络状态和设备信息
5. 点击"WiFi设置"可以重新配置WiFi连接

### 特殊情况处理

- **忘记ESP32的IP地址**: 可以通过路由器管理界面查看连接设备列表，或重启ESP32后重新配网
- **WiFi连接失败**: ESP32会保持AP模式，可再次连接到"ESP32开机助手"热点进行重新配置
- **无法连接到ESP32**: 尝试重启ESP32，或按住复位键5秒以上恢复出厂设置

## 注意事项

1. 舵机安装时需确保能够准确按下PC的电源按钮，建议进行多次测试调整
2. 确保ESP32的供电稳定，特别是舵机工作时电流需求较大
3. USB检测线路需正确连接到PC的USB供电端，以确保状态检测准确
4. 设备首次使用时，WiFi配置信息会保存在ESP32的NVS存储中，即使断电也不会丢失
5. 为保证安全，建议修改默认的AP密码

## 故障排除

| 问题 | 可能原因 | 解决方案 |
|------|---------|---------|
| 设备无法启动 | 供电不足 | 检查电源适配器，确保能提供至少500mA电流 |
| 无法连接到AP | 信号干扰 | 远离其他电子设备，或更换WiFi通道 |
| PC状态检测错误 | 检测线路问题 | 检查GPIO14连接，确保与USB检测电路正确连接 |
| 舵机无法按下电源键 | 舵机位置不准确 | 调整舵机安装位置，或修改servo_control.c中的角度值 |
| 网页无法访问 | 网络问题或IP变化 | 检查ESP32是否连接到WiFi，或重新查看IP地址 |

## 未来计划

- 添加手机APP控制功能
- 支持远程关机和重启功能
- 添加定时开关机功能
- 集成更多PC状态监控指标
