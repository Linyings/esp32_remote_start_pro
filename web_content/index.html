<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>远程开机助手</title>
  <style>
    :root {
      --primary-color: #4361ee;
      --secondary-color: #3f37c9;
      --success-color: #4cc9f0;
      --danger-color: #f72585;
      --off-color: #6c757d;
      --on-color: #06d6a0;
      --bg-color: #f4f6f8;
      --card-bg: #ffffff;
      --text-dark: #212529;
      --text-muted: #6c757d;
      --border-radius: 12px;
      --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      --transition: all 0.3s ease;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body { 
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
      margin: 0; 
      padding: 0; 
      background-color: var(--bg-color);
      color: var(--text-dark);
      line-height: 1.6;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .container { 
      max-width: 480px; 
      margin: 0 auto;
      padding: 20px;
      width: 100%;
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    header {
      text-align: center;
      padding-bottom: 20px;
      margin-bottom: 20px;
      border-bottom: 1px solid rgba(0,0,0,0.1);
    }

    h1 {
      font-size: 24px;
      font-weight: 600;
      margin-bottom: 8px;
      color: var(--primary-color);
    }

    .subtitle {
      font-size: 16px;
      color: var(--text-muted);
    }

    .card {
      background: var(--card-bg);
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      padding: 20px;
      margin-bottom: 20px;
      transition: var(--transition);
    }
    
    .card-controls {
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }

    .status-card {
      position: relative;
      overflow: hidden;
      padding: 25px;
      margin-bottom: 30px;
      text-align: center;
    }

    .status-indicator { 
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      font-size: 18px;
      padding: 20px;
      border-radius: var(--border-radius);
      transition: var(--transition);
    }

    .status-icon {
      width: 70px;
      height: 70px;
      border-radius: 50%;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: var(--transition);
    }

    .status-icon svg {
      width: 35px;
      height: 35px;
      transition: var(--transition);
    }

    .status-text {
      font-size: 18px;
      font-weight: 600;
      transition: var(--transition);
    }

    .on .status-icon { 
      background-color: rgba(6, 214, 160, 0.1);
      color: var(--on-color);
    }
    
    .off .status-icon { 
      background-color: rgba(108, 117, 125, 0.1);
      color: var(--off-color);
    }
    
    .on .status-text { 
      color: var(--on-color);
    }
    
    .off .status-text { 
      color: var(--off-color);
    }

    .action-buttons {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .power-btn { 
      background-color: var(--primary-color); 
      color: white; 
      border: none; 
      padding: 15px 25px;
      font-size: 18px; 
      font-weight: 500;
      border-radius: var(--border-radius); 
      cursor: pointer;
      transition: var(--transition);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    .power-btn:disabled { 
      background-color: #c9c9c9; 
      cursor: not-allowed;
      transform: none !important;
    }

    .power-btn:hover:not(:disabled) { 
      background-color: var(--secondary-color);
      transform: translateY(-2px);
    }

    .power-btn:active:not(:disabled) {
      transform: translateY(0);
    }

    .power-btn svg {
      width: 20px;
      height: 20px;
    }

    .settings-btn { 
      background-color: var(--off-color); 
      color: white; 
      border: none; 
      padding: 12px 20px;
      font-size: 16px; 
      font-weight: 500;
      border-radius: var(--border-radius); 
      cursor: pointer;
      transition: var(--transition);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      text-decoration: none;
    }

    .settings-btn:hover { 
      background-color: #5a6268;
      transform: translateY(-2px);
    }

    .settings-btn:active {
      transform: translateY(0);
    }

    .settings-btn svg {
      width: 18px;
      height: 18px;
    }

    .footer { 
      margin-top: auto;
      font-size: 14px; 
      color: var(--text-muted);
      text-align: center;
      padding: 20px 0 10px;
    }

    .expandable-card {
      margin-top: 20px;
      display: none;
    }

    .expandable-card.show {
      display: block;
      animation: fadeIn 0.3s ease;
    }

    .system-info {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .info-item {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px solid rgba(0,0,0,0.05);
    }

    .info-item:last-child {
      border-bottom: none;
    }

    .info-label {
      color: var(--text-muted);
      font-weight: 500;
    }

    .info-value {
      font-weight: 600;
    }

    .more-btn {
      background: none;
      border: none;
      color: var(--primary-color);
      cursor: pointer;
      padding: 5px;
      margin-top: 10px;
      font-size: 14px;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 5px;
      align-self: center;
    }

    .more-btn:hover {
      text-decoration: underline;
    }

    .pulse {
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0% {
        box-shadow: 0 0 0 0 rgba(76, 201, 240, 0.4);
      }
      70% {
        box-shadow: 0 0 0 10px rgba(76, 201, 240, 0);
      }
      100% {
        box-shadow: 0 0 0 0 rgba(76, 201, 240, 0);
      }
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* 响应式设计 */
    @media (max-width: 480px) {
      .container {
        padding: 15px;
      }
      
      h1 {
        font-size: 22px;
      }
      
      .power-btn {
        padding: 12px 20px;
        font-size: 16px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>电脑远程开机助手</h1>
      <p class="subtitle">随时随地轻松控制您的电脑</p>
    </header>

    <div class="card-controls">
      <div class="card status-card">
        <div id="status-indicator" class="status-indicator off">
          <div class="status-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M18.36 6.64A9 9 0 0 1 20.77 15"></path>
              <path d="M6.16 6.16a9 9 0 1 0 12.68 12.68"></path>
              <path d="M12 2v4"></path>
              <path d="m2 2 20 20"></path>
            </svg>
          </div>
          <div class="status-text">电脑已关机</div>
        </div>
      </div>

      <div class="action-buttons">
        <button id="power-btn" class="power-btn">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M18.36 6.64A9 9 0 1 1 5.64 5.64"></path>
            <path d="M12 2v10"></path>
          </svg>
          启动电脑
        </button>
        
        <a href="/setup" class="settings-btn">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"></path>
            <circle cx="12" cy="12" r="3"></circle>
          </svg>
          WiFi设置
        </a>

        <button id="more-btn" class="more-btn">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="m6 9 6 6 6-6"></path>
          </svg>
          详细信息
        </button>
      </div>

      <div id="expandable-card" class="card expandable-card">
        <div class="system-info">
          <div class="info-item">
            <span class="info-label">设备状态</span>
            <span id="device-status" class="info-value">在线</span>
          </div>
          <div class="info-item">
            <span class="info-label">连接方式</span>
            <span id="connection-type" class="info-value">Wi-Fi</span>
          </div>
          <div class="info-item">
            <span class="info-label">设备IP</span>
            <span id="device-ip" class="info-value">加载中...</span>
          </div>
          <div class="info-item">
            <span class="info-label">上次操作</span>
            <span id="last-action" class="info-value">--</span>
          </div>
        </div>
      </div>
    </div>
    
    <div class="footer">
      <p>通过WiFi设置按钮可以随时修改连接的家庭网络</p>
    </div>
  </div>

  <script>
    // DOM元素
    const statusIndicator = document.getElementById('status-indicator');
    const statusIcon = statusIndicator.querySelector('.status-icon');
    const statusText = statusIndicator.querySelector('.status-text');
    const powerBtn = document.getElementById('power-btn');
    const moreBtn = document.getElementById('more-btn');
    const expandableCard = document.getElementById('expandable-card');
    const deviceIp = document.getElementById('device-ip');
    const lastAction = document.getElementById('last-action');
    
    let isOn = false;
    let isExpanded = false;

    // 更新UI状态
    function updateStatus(on) {
      isOn = on;
      
      // 更新状态指示器
      statusIndicator.className = `status-indicator ${on ? 'on' : 'off'}`;
      
      if (on) {
        statusText.textContent = '电脑已开机';
        statusIcon.innerHTML = `
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M13 3H4a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-3"></path>
            <path d="M8 21h8"></path>
            <path d="M12 17v4"></path>
            <path d="M22 3v8"></path>
            <path d="m17 8 5-5"></path>
            <path d="m17 3 5 5"></path>
          </svg>
        `;
      } else {
        statusText.textContent = '电脑已关机';
        statusIcon.innerHTML = `
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M18.36 6.64A9 9 0 0 1 20.77 15"></path>
            <path d="M6.16 6.16a9 9 0 1 0 12.68 12.68"></path>
            <path d="M12 2v4"></path>
            <path d="m2 2 20 20"></path>
          </svg>
        `;
      }
      
      // 更新按钮状态
      powerBtn.disabled = on;
      
      if (on) {
        powerBtn.innerHTML = `
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
            <line x1="8" y1="12" x2="16" y2="12"></line>
          </svg>
          电脑已开机
        `;
      } else {
        powerBtn.innerHTML = `
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M18.36 6.64A9 9 0 1 1 5.64 5.64"></path>
            <path d="M12 2v10"></path>
          </svg>
          启动电脑
        `;
      }
    }

    // 发送开机命令
    powerBtn.addEventListener('click', async () => {
      if (isOn) return;
      
      powerBtn.disabled = true;
      const originalText = powerBtn.innerHTML;
      
      powerBtn.innerHTML = `
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="animate-spin">
          <path d="M21 12a9 9 0 1 1-6.219-8.56"></path>
        </svg>
        发送指令中...
      `;
      
      statusIcon.classList.add('pulse');

      try {
        const response = await fetch('/api/power', {
          method: 'POST',
        });

        if (response.ok) {
          const now = new Date();
          const timeString = now.toLocaleTimeString();
          lastAction.textContent = `开机 (${timeString})`;
          
          powerBtn.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
              <polyline points="22 4 12 14.01 9 11.01"></polyline>
            </svg>
            指令已发送
          `;
          
          setTimeout(() => {
            statusIcon.classList.remove('pulse');
            powerBtn.innerHTML = originalText;
            if (!isOn) powerBtn.disabled = false;
          }, 3000);
        } else {
          powerBtn.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="12" cy="12" r="10"></circle>
              <line x1="12" y1="8" x2="12" y2="12"></line>
              <line x1="12" y1="16" x2="12.01" y2="16"></line>
            </svg>
            发送失败
          `;
          
          setTimeout(() => {
            statusIcon.classList.remove('pulse');
            powerBtn.innerHTML = originalText;
            powerBtn.disabled = false;
          }, 3000);
        }
      } catch (error) {
        console.error('Error:', error);
        powerBtn.innerHTML = `
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="10"></circle>
            <line x1="12" y1="8" x2="12" y2="12"></line>
            <line x1="12" y1="16" x2="12.01" y2="16"></line>
          </svg>
          连接错误
        `;
        
        setTimeout(() => {
          statusIcon.classList.remove('pulse');
          powerBtn.innerHTML = originalText;
          powerBtn.disabled = false;
        }, 3000);
      }
    });
    
    // 切换扩展卡片
    moreBtn.addEventListener('click', () => {
      isExpanded = !isExpanded;
      expandableCard.classList.toggle('show', isExpanded);
      
      if (isExpanded) {
        moreBtn.innerHTML = `
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="m18 15-6-6-6 6"></path>
          </svg>
          收起详情
        `;
      } else {
        moreBtn.innerHTML = `
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="m6 9 6 6 6-6"></path>
          </svg>
          详细信息
        `;
      }
    });

    // WebSocket连接
    function connectWebSocket() {
      const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
      const ws = new WebSocket(`${protocol}//${window.location.host}/ws`);
      
      // 心跳定时器
      let heartbeatInterval = null;

      ws.onopen = () => {
        console.log('WebSocket连接已建立');
        
        // 每3秒发送一次心跳包
        heartbeatInterval = setInterval(() => {
          if (ws.readyState === WebSocket.OPEN) {
            ws.send(JSON.stringify({type: 'ping'}));
          }
        }, 3000);
      };

      ws.onmessage = (event) => {
        try {
          const data = JSON.parse(event.data);
          if (data.event === 'pc_state') {
            updateStatus(data.is_on);
          }
          // 不需要处理pong响应，只要服务器响应了任何消息就表示连接正常
        } catch (e) {
          console.error('解析WebSocket消息失败:', e);
        }
      };

      ws.onclose = () => {
        console.log('WebSocket连接已关闭，尝试重连...');
        
        // 清除心跳定时器
        if (heartbeatInterval) {
          clearInterval(heartbeatInterval);
          heartbeatInterval = null;
        }
        
        // 延迟重连，避免立即重连导致的高频重试
        setTimeout(connectWebSocket, 2000);
      };

      ws.onerror = (error) => {
        console.error('WebSocket错误:', error);
        
        // 清除心跳定时器
        if (heartbeatInterval) {
          clearInterval(heartbeatInterval);
          heartbeatInterval = null;
        }
        
        ws.close();
      };
      
      // 暴露WebSocket实例，允许在其他地方使用
      window.wsConnection = ws;
    }

    // 获取初始PC状态
    async function getInitialState() {
      try {
        const response = await fetch('/api/status');
        if (response.ok) {
          const data = await response.json();
          updateStatus(data.is_on);
          
          // 获取IP地址
          const ipResponse = await fetch('/api/network/info');
          if (ipResponse.ok) {
            const ipData = await ipResponse.json();
            if (ipData.ip) {
              deviceIp.textContent = ipData.ip;
            }
          }
        }
      } catch (error) {
        console.error('获取状态失败:', error);
        // 显示离线状态
        deviceIp.textContent = '连接错误';
        document.getElementById('device-status').textContent = '离线';
        document.getElementById('device-status').style.color = 'var(--danger-color)';
      }
    }

    // 初始化
    getInitialState();
    connectWebSocket();
    
    // 模拟网络信息API（如果后端没有实现，前端会显示本地IP）
    window.addEventListener('DOMContentLoaded', () => {
      fetch('/api/network/info').catch(() => {
        // 如果API不存在，使用当前页面URL作为IP
        const currentUrl = window.location.hostname;
        deviceIp.textContent = currentUrl;
      });
    });
  </script>
</body>
</html> 